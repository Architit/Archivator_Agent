{
  "block_id": "blk_20250820171407_000017",
  "parent_sha256": "7974308185c3c8c4c8fc8c8ea71b023adb7c735b21b233079b70b3e69cb8f665",
  "src_file": "file-tasks020_desktop_electron.md",
  "seq": 1,
  "total_seqs": 1,
  "encoding": "utf-8",
  "lang": "ru",
  "status": "ok",
  "size_bytes": 4863,
  "hash_sha256": "7974308185c3c8c4c8fc8c8ea71b023adb7c735b21b233079b70b3e69cb8f665",
  "tags": [],
  "text": "┌─ <file> tasks/020_desktop_electron.md\r\n│\r\n│ # 020 — Desktop App (Electron + React) ― «LAM Companion»\r\n│\r\n│ ## Overview\r\n│ Создаём полноценное десктоп-приложение, похожее на ChatGPT Desktop,\r\n│ но работаютщее с локальным/сетевым LAM-сервером:\r\n│ • Windows (.exe + NSIS installer)  \r\n│ • macOS (.dmg + auto-update)  \r\n│ • Linux (.AppImage)\r\n│\r\n│ Особенности MVP:\r\n│ 1. Окно «Chat» (чат, история, markdown, code-blocks).  \r\n│ 2. Вкладка «Dashboard» — ранее сделанная веб-панель.  \r\n│ 3. Трей-иконка + контекстное меню (Rest, Stop, Quit).  \r\n│ 4. Глобальный hotkey **Ctrl + Shift + L** → быстрое всплывающее\r\n│    Minichat («Spotlight»-стиль).  \r\n│ 5. Auto-update (через GitHub Releases).  \r\n│ 6. Запуск фонового LAM-процесса (*lam serve*) при старте,\r\n│    IPC ↔ Electron через http://127.0.0.1:8000 и WebSocket.\r\n│\r\n│ ## Goals / Acceptance\r\n│ - `npm run electron:dev` → окно с Chat и Dashboard.  \r\n│ - Инсталлятор Windows `LAM_Companion_Setup_x64.exe` < 150 MB,\r\n│   запускается без доп. зависимостей.  \r\n│ - Авто-апдейтер скачивает новую версию из GitHub Release\r\n│   (prerelease channel «beta»).  \r\n│ - При закрытии окна приложение сворачивается в трей\r\n│   (Quit — через меню).  \r\n│ - Ежели LAM-процесс падает (health / 1 с), Electron\r\n│   автоматически перезапускает и пишет toast «Engine restarted».  \r\n│ - E2E-тест `playwright` — отправили вопрос → получили\r\n│   markdown-ответ → code-block оборачивается в copy-button.  \r\n│\r\n│ ## LAM prompt\r\n│ «Определи UX-правила:  \r\n│  • максимальная длина одного сообщения,  \r\n│  • как подсвечивать RISK-ответы (этика),  \r\n│  • когда предлагать переключить LLM-провайдер (013) прямо\r\n│    из интерфейса.  \r\n│ Сформулируй текст всплывающих уведомлений (EN/RU)».\r\n│\r\n│ ## Codex prompt\r\n│ 1. **Электрон-каркас (TypeScript)**  \r\n│    - `main.ts`:  \r\n│        ```ts\r\n│        app.whenReady().then(createMainWindow)\r\n│        ipcMain.handle('send-message', …)  // fetch POST /intent\r\n│        ```  \r\n│    - `preload.ts`: contextBridge API `window.LAM.sendMessage()`.  \r\n│ 2. **Renderer (UI)**  \r\n│    - Переиспользовать React-код Dashboard (017) + новый\r\n│      `<Chat />` (shadcn/ui Textarea, MessageBubble).  \r\n│    - Markdown → `react-markdown` + `prismjs`.  \r\n│    - Store history в IndexedDB (Dexie).  \r\n│ 3. **LAM-backend launch**  \r\n│    - При `app.on('ready')` spawn `lam serve --port 8000`\r\n│      (cross-spawn, detached).  \r\n│    - Файл‐lock, чтоб не запустить второй экземпляр.  \r\n│ 4. **Auto-update**  \r\n│    - `electron-updater`, channel «beta», provider `github`.  \r\n│ 5. **Packaging**  \r\n│    ```json\r\n│    \"build\": {\r\n│      \"appId\": \"ai.lam.desktop\",\r\n│      \"productName\": \"LAM Companion\",\r\n│      \"asar\": true,\r\n│      \"files\": [\"dist/**\", \"static/**\", \"main.js\"],\r\n│      \"directories\": { \"buildResources\": \"resources\" },\r\n│      \"nsis\": { \"oneClick\": false, \"perMachine\": true },\r\n│      \"mac\":  { \"target\": \"dmg\" },\r\n│      \"linux\":{ \"target\": \"AppImage\" }\r\n│    }\r\n│    ```  \r\n│ 6. **E2E tests** — Playwright `chat.spec.ts`.\r\n│\r\n│ ## Operator prompt\r\n│ - **Dev-запуск**:  \r\n│     ```bash\r\n│     npm i\r\n│     npm run electron:dev\r\n│     ```  \r\n│   (фронт hot-reload, backend перезапускается)  \r\n│ - **Build + Release**:  \r\n│     ```bash\r\n│     npm run electron:build      # инсталляторы в dist/\r\n│     gh release create v1.0.0 -F CHANGELOG.md \\\r\n│        dist/*.exe dist/*.dmg dist/*.AppImage\r\n│     ```  \r\n│   приложение авто-обновится (если пользователь на beta-канале).  \r\n│ - **Code-sign** (Windows/macOS) — добавь сертификаты в GH Secrets.  \r\n│ - Проверка: после установки двойной клик ярлыка\r\n│   «LAM Companion» → чат-окно, в трее шестерёнка. Горячая клавиша\r\n│   Ctrl+Shift+L вызывает Minichat поверх всех окон.  \r\n│\r\n│ ∴\r\n└─\r\n"
}