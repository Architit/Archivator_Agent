{
  "block_id": "blk_20250820171407_000014",
  "parent_sha256": "61a36c69db8226b044df8084e05138947b506069562cad178334733bb785b372",
  "src_file": "file-tasks015_conscious_loop.md",
  "seq": 1,
  "total_seqs": 1,
  "encoding": "utf-8",
  "lang": "ru",
  "status": "ok",
  "size_bytes": 4167,
  "hash_sha256": "61a36c69db8226b044df8084e05138947b506069562cad178334733bb785b372",
  "tags": [],
  "text": "┌─ <file> tasks/015_conscious_loop.md\r\n│\r\n│ # 015 — Conscious Loop MVP\r\n│\r\n│ ## Overview\r\n│ Строим «живой» цикл из пяти ярусов. В первой версии берём\r\n│ упрощённый контур:\r\n│ 1. **ExperienceQueue** — общая асинхронная корзина сигналов.  \r\n│ 2. **Evaluator** — быстрый ярлык Valence (+ этический ID).  \r\n│ 3. **SelfState** — три показателя: fatigue, focus, stress.  \r\n│ 4. **Planner** — выдаёт один из трёх Intents {REST, STORE_MEMORY, SPEAK}.  \r\n│ 5. **Dispatcher** — исполняет Intent (лог, сон, запись памяти).  \r\n│\r\n│ Дополнения MVP:\r\n│ - Структурный JSON-лог через `logging_utils.JsonFormatter`.  \r\n│ - Коэффициенты усталости/стресса читаются из `.env`.  \r\n│ - Диаграмма пяти ярусов фиксируется в `docs/architecture.adoc`.  \r\n│ - Шорткат `make conscious` для локального вывода пульса.\r\n│\r\n│ ## Goals / Acceptance\r\n│ - Модули `lam/consciousness/*.py` компилируются (`mypy --strict`).  \r\n│ - `ConsciousEngine.tick()` < 150 мс при пустой очереди.  \r\n│ - 10 подряд Valence=RISK ⇒ `state.stress ≥ 0.8`, Planner → REST.  \r\n│ - После REST-Intenta fatigue ≤ 0.3, stress ≤ 0.3.  \r\n│ - Тест `tests/test_conscious_loop.py` доказывает рост/сброс.  \r\n│ - Демоскрипт `python -m lam.consciousness.demo_run` строчит\r\n│   JSON-логи вида  \r\n│     `{\"lvl\":\"INFO\",\"intent\":\"REST\",\"fatigue\":0.82,\"stress\":0.83}`.\r\n│\r\n│ ## LAM prompt\r\n│ «Составь базовый набор сигналов для ExperienceQueue\r\n│   (MemoryWrite, ProviderError, UserPing).  \r\n│   Примени формулы:  \r\n│     fatigue += FATIGUE_STEP (из .env) на каждый tick;  \r\n│     stress  += STRESS_RISK при Valence==RISK;  \r\n│     focus   -= 0.1, если fatigue>0.7;  \r\n│   REST сбрасывает fatigue = fatigue × 0.2, stress = stress × 0.3.»\r\n│\r\n│ ## Codex prompt\r\n│ 1. Создать пакеты  \r\n│    `lam/consciousness/{types.py,queue.py,state.py,planner.py,engine.py}`.  \r\n│ 2. Реализовать:\r\n│    - `ExperienceQueue` на `asyncio.Queue`.  \r\n│    - `Evaluator.tag` — POSITIVE, если kind==USER_MESSAGE; иначе RISK.  \r\n│    - `SelfState.update_from_valence` + `decay(dt_sec)`.  \r\n│    - `Planner.choose`  \r\n│        ```python\r\n│        if state.stress > REST_THRESHOLD or state.fatigue > REST_THRESHOLD:\r\n│            return Intent(IntentKind.REST)\r\n│        elif state.focus < 0.3:\r\n│            return Intent(IntentKind.SPEAK, {\"msg\": \"Need clarity\"})\r\n│        else:\r\n│            return Intent(IntentKind.STORE_MEMORY)\r\n│        ```  \r\n│    - `Dispatcher.execute`:  \r\n│        REST → `await asyncio.sleep(1)`;  \r\n│        STORE_MEMORY → `logger.info(\"store memory\", extra=state.dict())`;  \r\n│        SPEAK → `logger.info(\"speak\", extra={\"msg\": payload[\"msg\"]})`.  \r\n│ 3. Юнит-тест: monkeypatch `sleep` и фиксированное время (`freezegun`).  \r\n│ 4. `docs/architecture.adoc` + PlantUML диаграмма.  \r\n│ 5. Make-цель:  \r\n│        `conscious: PYTHONPATH=. python -m lam.consciousness.demo_run`\r\n│\r\n│ ## Operator prompt\r\n│ - Добавь в `.env` (и `.env.example`):  \r\n│     ```\r\n│     FATIGUE_STEP=0.05\r\n│     STRESS_RISK=0.2\r\n│     REST_THRESHOLD=0.8\r\n│     CONSCIOUS_LOG_LEVEL=INFO\r\n│     ```\r\n│ - Локально:  \r\n│     ```bash\r\n│     make conscious          # смотри пульс в реальном времени\r\n│     pytest -q               # тесты должны быть зелёные\r\n│     ```  \r\n│ - В PR проверь логи CI — latency и mypy-strict.  \r\n│ - После мержа внеси диаграмму в README (раздел «Живой цикл»).\r\n│\r\n│ ∴\r\n└─\r\n"
}