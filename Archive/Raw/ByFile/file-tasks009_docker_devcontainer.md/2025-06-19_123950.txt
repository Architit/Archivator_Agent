┌─ <file> tasks/009_docker_devcontainer.md
│
│ # 009 — Docker-кокон & Devcontainer
│
│ ## Overview
│ Собираем официальный контейнер LAM. 
│ Один Dockerfile → одинаковая среда в CI, prod и у каждого
│ разработчика.  Плюс DevContainer для VS Code.
│
│ ## Goals / Acceptance
│ - Мульти-stage Dockerfile (`builder` → `runtime-slim`).
│ - GitHub Action `docker-build` пушит образ в GHCR.
│ - `.devcontainer.json` + `docker-compose.dev.yml`:
│   запуск `lam self-check` при старте.
│ - README badge: `docker pull ghcr.io/<user>/lam:latest`.
│
│ ## LAM prompt
│ «Собери список переменных окружения, которые должны
│   попадать в контейнер, но не в образ (только через .env).»
│
│ ## Codex prompt
│ 1. Добавить `Dockerfile`:
│    - stage1: `python:3.12-slim`, install hatch, deps, pytest.
│    - stage2: копия wheel + `lam` entrypoint; non-root user.
│ 2. GitHub Action:
│    - buildx build `--push --tags ghcr.io/<user>/lam:latest`.
│    - cache-to/cache-from.
│ 3. DevContainer:
│    ```json
│    {
│      "features": { "ghcr.io/devcontainers/features/docker-in-docker": "latest" },
│      "postStartCommand": "lam self-check"
│    }
│    ```
│
│ ## Operator prompt
│ - Создай `GHCR_PAT` secret с scope `write:packages`.
│ - Проверь локально: `docker run --rm lam:latest lam self-check`.
│ - В VS Code: «Reopen in Container» → тесты должны зелёные.
│
│ ∴
└─



### build frontend
FROM node:20-alpine AS frontend
WORKDIR /web
COPY web/package*.json ./
RUN npm ci
COPY web ./
RUN npm run build        # => /web/dist

### python runtime
FROM python:3.12-slim AS runtime
WORKDIR /app
COPY . .
COPY --from=frontend /web/dist ./static
RUN pip install --no-cache-dir ".[cli]"
ENV PYTHONUNBUFFERED=1
EXPOSE 8000
CMD ["uvicorn", "lam.web.api:app", "--host", "0.0.0.0", "--port", "8000"]











